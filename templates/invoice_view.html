{% extends 'base.html' %}

{% block title %}Invoice {{ invoice.invoice_number }} - R Sanju Store{% endblock %}

{% block content %}
<section class="page invoice-view">
  <div class="page-header">
    <h2>Invoice {{ invoice.invoice_number }}</h2>
    <div>
      <button class="btn" onclick="window.print()">Print / Save as PDF</button>
      <a class="btn" href="{{ url_for('download_invoice', invoice_id=invoice.id) }}">Download Invoice</a>
      <a class="btn" href="{{ url_for('invoice_list') }}">Back to list</a>
    </div>
  </div>

  <section class="store-details">
    <h3>{{ store.store_name or 'R Sanju Store' }}</h3>
    {% if store.address %}
      <p>{{ store.address }}</p>
    {% endif %}
    {% if store.phone or store.email %}
      <p>
        {% if store.phone %}Phone / WhatsApp: {{ store.phone }}{% endif %}
        {% if store.phone and store.email %} | {% endif %}
        {% if store.email %}Email: {{ store.email }}{% endif %}
      </p>
    {% endif %}
  </section>

  <section class="invoice-meta">
    <div>
      <p><strong>Invoice Number:</strong> {{ invoice.invoice_number }}</p>
      <p><strong>Invoice Date:</strong> {{ invoice.invoice_date }}</p>
      <p><strong>Created At (date &amp; time):</strong> {{ invoice.created_at }}</p>
    </div>
    <div>
      <p><strong>Customer:</strong> {{ invoice.customer_name or '-' }}</p>
      {% if invoice.customer_phone %}<p><strong>Phone:</strong> {{ invoice.customer_phone }}</p>{% endif %}
      {% if invoice.customer_address %}<p><strong>Address:</strong> {{ invoice.customer_address }}</p>{% endif %}
      {% if invoice.customer_gstin %}<p><strong>GSTIN:</strong> {{ invoice.customer_gstin }}</p>{% endif %}
    </div>
  </section>

  <h3>Items</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Description</th>
        <th>Qty</th>
        <th>Unit Price</th>
        <th>Line Total</th>
      </tr>
    </thead>
    <tbody>
      {% for item in invoice['items'] %}
        <tr>
          <td>{{ item.description }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ '%.2f'|format(item.unit_price) }}</td>
          <td>{{ '%.2f'|format(item.line_total) }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="totals-grid invoice-totals">
    <div>
      <h3>Payment Details</h3>
      <p>
        <strong>Payment Mode:</strong>
        {% if invoice.payment_mode %}
          <span class="badge badge-payment-{{ (invoice.payment_mode or 'OTHER')|lower }}">
            {{ invoice.payment_mode }}
          </span>
        {% else %}
          -
        {% endif %}
      </p>

      {% if invoice.payment_mode == 'CREDIT' %}
        <form method="post" action="{{ url_for('convert_credit_to_cash', invoice_id=invoice.id) }}" onsubmit="return confirm('Convert this invoice from CREDIT to CASH?');">
          <button type="submit" class="btn small">Convert CREDIT to CASH</button>
        </form>
      {% endif %}

      {% if invoice.payment_reference %}
        <p><strong>Reference:</strong> {{ invoice.payment_reference }}</p>
      {% endif %}
      {% if invoice.notes %}
        <p><strong>Notes:</strong> {{ invoice.notes }}</p>
      {% endif %}
    </div>

    <div class="totals-box">
      <div class="totals-row">
        <span>Subtotal:</span>
        <span>{{ '%.2f'|format(invoice.subtotal or 0) }}</span>
      </div>
      <div class="totals-row">
        <span>Discount:</span>
        <span>{{ '%.2f'|format(invoice.discount or 0) }}</span>
      </div>
      <div class="totals-row">
        <span>Tax:</span>
        <span>{{ '%.2f'|format(invoice.tax or 0) }}</span>
      </div>
      <div class="totals-row grand-total">
        <span>Total:</span>
        <span>{{ '%.2f'|format(invoice.total or 0) }}</span>
      </div>
    </div>
  </div>

  <footer class="invoice-footer">
    <p>Thank you for shopping at {{ store.store_name or 'R Sanju Store' }}.</p>
  </footer>
</section>
{% endblock %}
